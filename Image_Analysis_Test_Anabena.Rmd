---
title: "Image-Analysis-Test_Anabena"
author: "Tyler E. Harman"
date: "8/6/2021"
output: word_document
---

```{r}
library(EBImage)
library(tiff)
library(pixmap)
```

The following code is a collection of for loops that is based off of the Pokrzywinski et al., 2019 technical report (https://erdc-library.erdc.dren.mil/jspui/handle/11681/33870) utilizing R to automate cell counts of fluorescent microscopy images. This code uses [EBImage](https://www.bioconductor.org/packages/release/bioc/html/EBImage.html), [tiff](https://cran.r-project.org/web/packages/tiff/index.html), and [pixmap](https://cran.r-project.org/web/packages/pixmap/index.html) packages.

## Cell Counting Script (fluorescent channel 1)

The following for loops are taken from the 2019 technical report, but split into two different collections for two different fluorescent channels. Ultimately, this will be beneficial for researchers who want to detect differences in live/dead cells or different counts of fluorescent markers.

First, we need to convert the microscopy images into 8-bit greyscale images in order for the code to correctly analyze these images for the counting process:
```{r}
for(i in 1:1){
  F1_path<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test F1/")
  grey_F1_savdir<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F1_Grey/")
  F1_files<-list.files(F1_path,pattern="tif",full.name=F)
}
```

This takes the images from a pre-determined path and saves these converted files into a new save directory

The following code is the for-loop that converts the images to greyscale for all images within the pre-determined path

```{r}
for(i in 1:length(F1_files)){
  grey_image <- paste0(sub(".tif",replacement="",x=F1_files[i]),"_grey.tiff")
  image <- readTIFF(paste0(F1_path,F1_files[i]))
  image <- 2*image
  bar <- image[,,1]+image[,,2]+image[,,3]
  bar <- bar/max(bar)
  ImgF1=normalize(bar,inputRange=c(0.2,0.75))
  writeTIFF(ImgF1,paste0(grey_F1_savdir,"/",grey_image))
}
display(ImgF1)
```

This code corrects the contrast from the original image using the "image <- 2*image" code, while the "bar" variables convert the image to greyscale, and finnaly the 'normalize' function is used to reduce background noise below the 0.2 threshold.

Next, the images go through the following code to process the newly converted greyscale images to be mapped for further processing:
```{r}
for(i in 1:1){
  map_pathF1<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F1_Grey/")
  mapF1_savdir<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F1_Map/")
  map_F1files<-list.files(map_pathF1,pattern="tif",full.name=F)
}
for(i in 1:length(map_F1files)){
  mapped_image <- paste0(sub(".tiff", replacement="", x=map_F1files[i]),"_mapped.tiff")
  map1 <- readTIFF(paste0(map_pathF1,map_F1files[i]))
  map2 <- as.matrix(map1)
  map2[map2<0.3] <- 0
  writeTIFF(map2,paste0(mapF1_savdir,"/",mapped_image))
}
```

Once these images are processed, the last step is to generate the needed files paths for pulling/saving images, as well as creating a file path for saving a generated .csv file for the resulting data, as well as generating a data frame for the data to be loaded into:
```{r}
for(i in 1:1){
  image_pathF1<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F1_Map/")
  image_F1savdir<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F1_Analysis/")
  image_F1files<-list.files(image_pathF1,pattern="tiff",full.name=F)
  csv_F1path<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F1_Matrices/")
  resultsF1 <- data.frame(image=rep(NA, length(image_F1files)), count = rep(NA,length(image_F1files)))
}
```

Once these paths are made, the following code goes through each image within the pre-determined file path with mapped images and processes them for counting:
```{r}
for(i in 1:length(image_F1files)){
  analyzed_image <- paste0(sub(".tiff", replacement = "", x = image_F1files[i]),"_analyzed.tiff")
  image_matrix <- paste0(sub(".tiff", replacement = "", x = image_F1files[i]), "_matrix.csv")
  img1 <- readTIFF(paste0(image_pathF1,image_F1files[i]))
  img2 <- thresh(img1,w=17,h=17,offset=0.001)
  display(img2,method="raster")
  nmaskt <- watershed(distmap(img2),0.5)
  nmaskt <- fillHull(nmaskt)
  img3 <- colorLabels(nmaskt,normalize=T)
  display(img3, method="raster",all=F)
  count <- max(nmaskt)
  dims=dim(nmaskt)
  border=c(nmaskt[1:dims[1],1],nmaskt[1:dims[1],dims[2]], nmaskt[1,1:dims[2]],nmaskt[dims[1],1:dims[2]])
  ids=unique(border[which(border !=0)])
  inner=rmObjects(nmaskt,ids)
  count2 <- max(inner)
  img4 <- colorLabels(inner,normalize=T)
  display(img4, method="raster")
  writeImage(img4, files=paste0(image_F1savdir,"/",analyzed_image))
  write.csv(inner,file=paste0(csv_F1path,"/",image_matrix))
  resultsF1$image[i] <- analyzed_image
  resultsF1$count[i] <- count
  resultsF1$edge[i] <- length(ids)
  resultsF1$inner[i] <- count2
}
display(img4)
```

This code highlights individual cells with a unique color for the loop to eventually count as accurately as possible, as you can see with the image from above. The last amount of code is used to write the data from "resultsF1" to a .csv file:
```{r}
write.csv(resultsF1,paste0(image_F1savdir,"/F1_counts.csv"))
```

## Fluorescent channel 2 counts

The following code is similar to the fluorescent channel 1 code, but optimized for images within separate file paths:
```{r}
for(i in 1:1){
  #Path/directory/list of greyscale imaging
  F2_path<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test F2/")
  grey_F2_savdir<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F2_Grey/")
  F2_files<-list.files(F2_path,pattern="tif",full.name=F)
}

#create loop for batch converting F2 images to greyscale
for(f in 1:length(F2_files)){
  grey_image <- paste0(sub(".tif",replacement="",x=F2_files[f]),"_grey.tiff")
  image <- readTIFF(paste0(F2_path,F2_files[f]))
  image <- 2*image
  bar<- image[,,1]+image[,,2]+image[,,3]
  bar <- bar/max(bar)
  ImgF2=normalize(bar,inputRange=c(0.2,0.75))
  writeTIFF(ImgF2,paste0(grey_F2_savdir,"/",grey_image))
}

for(i in 1:1){
  #Path/directory/list of pixel maps
  map_pathF2<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F2_Grey/")
  mapF2_savdir<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F2_Map/")
  map_F2files<-list.files(map_pathF2,pattern="tif",full.name=F)
}

#create loop for batch image processing/creating mapped images
for(i in 1:length(map_F2files)){
  mapped_image <- paste0(sub(".tiff", replacement="", x=map_F2files[i]),"_mapped.tiff")
  map1 <- readTIFF(paste0(map_pathF2,map_F2files[i]))
  map2 <- as.matrix(map1)
  map2[map2<0.3] <- 0
  writeTIFF(map2,paste0(mapF2_savdir,"/",mapped_image))
}

for(i in 1:1){
  #Path/directory/list for images for processing
  image_pathF2<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F2_Map/")
  image_F2savdir<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F2_Analysis/")
  image_F2files<-list.files(image_pathF2,pattern="tiff",full.name=F)
  #Path to save csv files from image matrix - visual reference
  csv_F2path<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F2_Matrices/")
  #create loop to process and count the new images
  resultsF2 <- data.frame(image=rep(NA, length(image_F2files)), count = rep(NA,length(image_F2files)))
}

#create loop to process and count the new images
for(i in 1:length(image_F2files)){
  analyzed_image <- paste0(sub(".tiff", replacement = "", x = image_F2files[i]),"_analyzed.tiff")
  image_matrix <- paste0(sub(".tiff", replacement = "", x = image_F2files[i]), "_matrix.csv")
  img1 <- readTIFF(paste0(image_pathF2,image_F2files[i]))
  img2 <- thresh(img1,w=17,h=17,offset=0.001)
  display(img2,method="raster")
  nmaskt <- watershed(distmap(img2),0.5)
  nmaskt <- fillHull(nmaskt)
  img3 <- colorLabels(nmaskt,normalize=T)
  display(img3, method="raster",all=F)
  count <- max(nmaskt)
  dims=dim(nmaskt)
  border=c(nmaskt[1:dims[1],1],nmaskt[1:dims[1],dims[2]], nmaskt[1,1:dims[2]],nmaskt[dims[1],1:dims[2]])
  ids=unique(border[which(border !=0)])
  inner=rmObjects(nmaskt,ids)
  count2 <- max(inner)
  img4 <- colorLabels(inner,normalize=T)
  display(img4, method="raster")
  writeImage(img4, files=paste0(image_F2savdir,"/",analyzed_image))
  write.csv(inner,file=paste0(csv_F1path,"/",image_matrix))
  resultsF2$image[i] <- analyzed_image
  resultsF2$count[i] <- count
  resultsF2$edge[i] <- length(ids)
  resultsF2$inner[i] <- count2
}

write.csv(resultsF2,paste0(image_F2savdir,"/F2_counts.csv"))
```

## Multi-layered imaging analysis

Once the following counting procedures have been completed, the following code will take the grey-scale images produced previously to create outlines of the cells using the 'bwlabel' function. This creates black and white images of the cells for the 'propagate' function to accurately generate cell outlines.

The following code loads the needed file paths:
```{r}
for(i in 1:1){
  grey_pathF1<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F1_Grey/")
  grey_pathF2<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F2_Grey/")
  multi_savdir<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_Multi/")
  grey_filesF1<-list.files(grey_pathF1,pattern="tif",full.name=F)
  grey_filesF2<-list.files(grey_pathF2,pattern="tif",full.name=F)
}
```

Next, the following nested-loop processes these grey-scale images one at a time, then ultimately deletes the greyscale images after the multi-layered imaging is completed.

First, the file paths are reloaded within the nested-loop. As the nested-loop continues, these file paths need to be reloaded in order for the loop to begin the next image that's in line. In addition, another for-loop in placed after the reloading of the file paths in order to load in the file name of the first available image and associate it to a variable, in this case, being 'analyzed image'. This writes '_multi.tiff' to the file name:
```{r}
for(i in 1:length(grey_filesF1)){
  grey_pathF1<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F1_Grey/")
  grey_pathF2<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_F2_Grey/")
  multi_savdir<-("D:/NOAA Work/Cell Count Project/Multi-Detection/Test 2/Test_Multi/")
  grey_filesF1<-list.files(grey_pathF1,pattern="tif",full.name=F)
  grey_filesF2<-list.files(grey_pathF2,pattern="tif",full.name=F)
  for(i in 1:length(grey_filesF1)){
    analyzed_image <- paste0(sub(".tiff", replacement = "", x = grey_filesF1[i]),"_multi.tiff")
    break
  }
}
```

The remaining code within the nested-loop creates these 'bwlabel' images for the first image in line for each file path for F1 and F2 images. Notice the 'break' within the for-loops; this stops the for-loop to only process one image at a time:
```{r}
  for(i in 1:length(grey_filesF1)){
    image_greyF1 <- readImage(paste0(grey_pathF1,grey_filesF1[i]))
    ImgF1=normalize(image_greyF1,inputRange=c(0,0.75))
    F1_lab<-thresh(ImgF1,w=15,h=15,offset=0.05)
    F1_lab<-opening(F1_lab,makeBrush(5,shape='disc'))
    F1_lab<-fillHull(F1_lab)
    F1_lab<-bwlabel(F1_lab)
    break
  }
  for(f in 1:length(grey_filesF2)){
    image_greyF2 <- readImage(paste0(grey_pathF2,grey_filesF2[f]))
    ImgF2=normalize(image_greyF2,inputRange=c(0,0.75))
    F2_lab<-thresh(ImgF2,w=15,h=15,offset=0.05)
    F2_lab<-opening(F2_lab,makeBrush(5,shape='disc'))
    F2_lab<-fillHull(F2_lab)
    F2_lab<-bwlabel(F2_lab)
    break
  }
display(F1_lab)
display(F2_lab)
```

Once these images are made, the following code creates a colored layered image, as well as taking the 'bwlabel' images (i.e., F1_lab and F2_lab) and creaties outlines using the 'propagate' function, and saves the file to a pre-determined save directory:
```{r}
  img=rgbImage(red=ImgF2,blue=1.5*ImgF1)
  F2_mask<-opening(F2_lab)
  F2_mask2<-propagate(F2_lab,seeds=F2_lab,mask=F2_mask)
  res=paintObjects(F2_mask2,img,col='#ff00ff')
  res=paintObjects(F1_lab,res,col='#f0fff0')
  writeImage(res, files=paste0(multi_savdir,"/",analyzed_image))
  display(res)
```

Once the image has been saved, we now need to delete the grey-scale images used in this one analysis, in order for the nested-loop to process the next image in line (i.e., number 2, number 3, etc.). The following code deletes the grey-scale images from each fluorescent channel file path; notice the 'break' function, as we only want to delete the first file in the respective file path:
```{r}
  for(i in 1:length(grey_filesF1)){
    if(file.exists(paste0(grey_pathF1,grey_filesF1[i])))
      file.remove(paste0(grey_pathF1,grey_filesF1[i]))
    break
  }
  for(f in 1:length(grey_filesF2)){
    if(file.exists(paste0(grey_pathF2,grey_filesF2[f])))
      file.remove(paste0(grey_pathF2,grey_filesF2[f]))
    break
  }
```

This nested loop will run automatically, doing the following code for the length of the files that are processed.
